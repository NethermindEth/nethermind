name: Build StatelessExecution RISC-V

on:
  merge_group:
    types: [checks_requested]
  pull_request:
    paths:
      - "tools/StatelessExecution/**"
      - ".github/workflows/build-stateless-execution-riscv.yml"
  push:
    paths:
      - "tools/StatelessExecution/**"
      - ".github/workflows/build-stateless-execution-riscv.yml"
  workflow_dispatch:

jobs:
  build-zisk-sim:
    name: Build for Zisk simulator
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/riscv64

      - name: Install QEMU RISC-V user mode
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user qemu-user-static

      - name: Build .NET tool
        working-directory: tools/StatelessExecution
        run: make build-tool-local

      - name: Build ZISK Simulator binary
        working-directory: tools/StatelessExecution
        run: make build-zisk-sim

      - name: Execute with QEMU
        working-directory: tools/StatelessExecution
        run: |
          echo "Running Program with QEMU..."
          DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1 ./Program
          EXIT_CODE=$?
          echo "Exit code: $EXIT_CODE"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Program execution failed with exit code $EXIT_CODE"
            exit 1
          fi
          echo "::notice::Program executed successfully with exit code 0"

      - name: Execute Zisk Sim binary on on RISC-V host
        working-directory: tools/StatelessExecution
        env:
          STATELESS_EXECUTOR_RISCV_HOST: ${{ secrets.STATELESS_EXECUTOR_RISCV_HOST }}
          STATELESS_EXECUTOR_RISCV_USERNAME: ${{ secrets.STATELESS_EXECUTOR_RISCV_USERNAME }}
          STATELESS_EXECUTOR_RISCV_SSH_PRIVATE_KEY: ${{ secrets.STATELESS_EXECUTOR_RISCV_SSH_PRIVATE_KEY }}
        run: |
          ./stateless_exec_test.sh

      - name: Upload ZISK Simulator binary
        uses: actions/upload-artifact@v4
        with:
          name: stateless-execution-zisk-sim
          path: tools/StatelessExecution/Program
          if-no-files-found: error

  build-zisk:
    name: Build for Zisk
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build .NET tool
        working-directory: tools/StatelessExecution
        run: make build-tool-local

      - name: Build ZISK binary
        working-directory: tools/StatelessExecution
        run: make build-zisk

      - name: Upload ZISK binary
        uses: actions/upload-artifact@v4
        with:
          name: stateless-execution-zisk
          path: tools/StatelessExecution/Program
          if-no-files-found: error
