name: '[JSON-RPC] Compare Nethermind between clients and versions'

on:
  push:
    branches:
      - 'rpc-comparison-testing-v1.20.1'
  workflow_dispatch:
    inputs:
      allowed_ips:
        type: string
        description: "A comma-separated list of ips allowed to connect to the node"
        default: ''
        required: false

jobs:
  create_node: 
    name: Create node from current branch
    uses: ./.github/workflows/run-a-single-node-from-branch.yml
    secrets: inherit
    with:
      allowed_ips: ${{ inputs.allowed_ips }}
      non_validator_mode: false
      additional_nethermind_flags: Pruning.Mode=None
  
  extract_rpc_url:
    name: Extract RPC url from artifacts generated by create_node 
    runs-on: ubuntu-latest
    needs: create_node
    outputs:
      rpc_url: ${{ steps.extract_rpc_url.outputs.rpc_url }}
    steps:
      - name: Download artifact
        id: download-artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.REPOSITORY_DISPATCH_TOKEN }}
          run_id: ${{ needs.create_node.outputs.run_id }}
          name: "${{ github.actor }}-${{ needs.create_node.outputs.base_tag }}-smoketests"
          repo: NethermindEth/post-merge-smoke-tests

      - run: echo "${{ github.actor }}-${{ needs.create_node.outputs.base_tag }}-smoketests"
      - run: echo "${{ github.actor }}-${{ needs.create_node.outputs.rpc_url }}-smoketests"

      - name: Get RPC url to the newly created node
        id: extract_rpc_url
        run: echo "rpc_url=$(cat ./terraform.tfstate | jq '.outputs.nodes_data.value[0].rpc_url')" >> $GITHUB_OUTPUT
  
  wait_for_node_to_sync:
    name: Wait for the node to sync
    runs-on: ubuntu-latest
    needs: extract_rpc_url
    timeout-minutes: 600
    steps:
    - uses: actions/checkout@v3
    - name: Install WireGuard
      run: |
        sudo apt update
        sudo apt install -y wireguard resolvconf
        sudo mkdir -p /etc/wireguard
        envsubst < scripts/wireguard.conf.template > wg0.conf
        sudo wg-quick up ./wg0.conf
      env:
        WIREGUARD_PRIVKEY: '${{ secrets.WIREGUARD_PRIVKEY }}'
        WIREGUARD_ADDRESS: '${{ secrets.WIREGUARD_ADDRESS }}'
        WIREGUARD_DNS: '${{ secrets.WIREGUARD_DNS }}'
        WIREGUARD_PUBKEY: '${{ secrets.WIREGUARD_PUBKEY }}'
        WIREGUARD_PRESHAREDKEY: '${{ secrets.WIREGUARD_PRESHAREDKEY }}'
        WIREGUARD_ALLOWED_IPS: '${{ secrets.WIREGUARD_ALLOWED_IPS }}'
        WIREGUARD_SERVER_IP: '${{ secrets.WIREGUARD_SERVER_IP }}'
        WIREGUARD_SERVER_PORT: '${{ secrets.WIREGUARD_SERVER_PORT }}'
    
    - name: Wait for the node to sync
      run: |
        while curl -X POST --data '{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}' ${{ needs.extract_rpc_url.outputs.rpc_url }} | jq -e '.result'
        do sleep 300; done 

  compare:
    name: Compare JSON-RPC responses between clients and versions
    runs-on: ubuntu-latest
    needs: [extract_rpc_url, wait_for_node_to_sync]
    strategy:
      matrix:
        rpc_to_compare: [INFURA_ENDPOINT, NETHERMIND_ARCHIVE_ENDPOINT]
    steps:
    - uses: actions/checkout@v3
    - name: Install flood
      run: pip install git+https://github.com/piwonskp/flood.git

    - name: Install WireGuard
      run: |
        sudo apt update
        sudo apt install -y wireguard resolvconf
        sudo mkdir -p /etc/wireguard
        envsubst < scripts/wireguard.conf.template > wg0.conf
        sudo wg-quick up ./wg0.conf
      env:
        WIREGUARD_PRIVKEY: '${{ secrets.WIREGUARD_PRIVKEY }}'
        WIREGUARD_ADDRESS: '${{ secrets.WIREGUARD_ADDRESS }}'
        WIREGUARD_DNS: '${{ secrets.WIREGUARD_DNS }}'
        WIREGUARD_PUBKEY: '${{ secrets.WIREGUARD_PUBKEY }}'
        WIREGUARD_PRESHAREDKEY: '${{ secrets.WIREGUARD_PRESHAREDKEY }}'
        WIREGUARD_ALLOWED_IPS: '${{ secrets.WIREGUARD_ALLOWED_IPS }}'
        WIREGUARD_SERVER_IP: '${{ secrets.WIREGUARD_SERVER_IP }}'
        WIREGUARD_SERVER_PORT: '${{ secrets.WIREGUARD_SERVER_PORT }}'

    - name: Test equality of responses
      run: flood all nethermind_current=${{ needs.extract_rpc_url.outputs.rpc_url }} ${{ matrix.rpc_to_compare }}=${{ secrets[matrix.rpc_to_compare] }} --equality
