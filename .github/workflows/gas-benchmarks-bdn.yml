name: Gas Benchmarks (BDN)

on:
  push:
    branches: [master]
    paths: ['src/Nethermind/**']
  pull_request:
    branches: [master]
    types: [labeled]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Benchmark mode (Block or EVM)'
        required: false
        default: 'Block'
        type: choice
        options:
          - Block
          - EVM
      filter:
        description: 'BDN filter pattern (optional, e.g. *MULMOD*)'
        required: false
        default: ''

env:
  DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: "1"
  TERM: xterm

jobs:
  resolve:
    if: >-
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.label.name == 'performance is good')
    runs-on: ubuntu-slim
    outputs:
      mode: ${{ steps.check.outputs.mode }}
      filter: ${{ steps.check.outputs.filter }}
    steps:
      - name: Resolve inputs
        id: check
        shell: bash
        run: |
          set -euo pipefail

          mode="Block"
          filter=""

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            mode="${{ inputs.mode }}"
            filter="${{ inputs.filter }}"
          fi

          {
            echo "mode=${mode}"
            echo "filter=${filter}"
          } >> "$GITHUB_OUTPUT"

  benchmark:
    needs: resolve
    if: always() && !cancelled() && needs.resolve.result == 'success'
    runs-on: [self-hosted, Linux, X64, benchmark]
    strategy:
      fail-fast: false
      matrix:
        chunk: [1, 2, 3, 4, 5]
    timeout-minutes: 240
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          lfs: true
          submodules: true

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Build benchmarks
        run: dotnet build src/Nethermind/Nethermind.Evm.Benchmark -c Release

      - name: Run benchmarks (chunk ${{ matrix.chunk }}/5)
        shell: bash
        run: |
          MODE="${{ needs.resolve.outputs.mode }}"
          FILTER="${{ needs.resolve.outputs.filter }}"

          ARGS="--inprocess --mode=$MODE --chunk ${{ matrix.chunk }}/5"
          if [[ -n "$FILTER" ]]; then
            ARGS="$ARGS --filter $FILTER"
          fi

          dotnet run --project src/Nethermind/Nethermind.Evm.Benchmark -c Release --no-build -- $ARGS

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bdn-results-${{ matrix.chunk }}
          path: BenchmarkDotNet.Artifacts/results/*-full.json
          retention-days: 90

  collect:
    needs: [resolve, benchmark]
    if: always() && !cancelled() && needs.resolve.result == 'success' && needs.benchmark.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: bdn-results-*
          path: results/
          merge-multiple: true

      - name: Merge chunk results
        run: python3 scripts/benchmarks/merge_bdn_results.py results/ pr-results.json

      - name: Upload merged results
        uses: actions/upload-artifact@v4
        with:
          name: bdn-results-merged
          path: pr-results.json
          retention-days: 90

      # On master push: cache results as baseline for future PR comparisons
      - name: Cache master baseline
        if: github.ref == 'refs/heads/master'
        run: cp pr-results.json baseline.json

      - name: Save master cache
        if: github.ref == 'refs/heads/master'
        uses: actions/cache/save@v4
        with:
          path: baseline.json
          key: gas-benchmark-bdn-${{ github.sha }}

      # On PR: restore master baseline and compare
      - name: Restore master baseline
        if: github.event_name == 'pull_request'
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: baseline.json
          key: gas-benchmark-bdn-
          restore-keys: gas-benchmark-bdn-

      - name: Compare against master
        if: github.event_name == 'pull_request' && steps.cache-restore.outputs.cache-hit == 'true'
        run: python3 scripts/benchmarks/compare_bdn_results.py baseline.json pr-results.json > comparison.md

      - name: Post comparison to PR
        if: github.event_name == 'pull_request' && steps.cache-restore.outputs.cache-hit == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: gas-benchmark-bdn
          path: comparison.md
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
