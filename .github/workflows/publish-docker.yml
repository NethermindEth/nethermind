name: Publish Docker image

on:
  pull_request:
    branches: [master, release/*, paprika]

  push:
    branches: [master, release/*, paprika]
    paths: [src/Nethermind/**]

  workflow_dispatch:
    inputs:
      image-name:
        description: Image name
        required: true
        default: nethermind
      tag:
        description: Image tag
        required: true
      dockerfile:
        description: Dockerfile
        required: true
        default: Dockerfile
      build-config:
        description: Build configuration
        required: true
        default: release
        type: choice
        options: [release, debug]

permissions:
  id-token: write
  attestations: write
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      BUILD_TIMESTAMP: ${{ steps.env-vars.outputs.BUILD_TIMESTAMP }}
      EXTRA_TAGS: ${{ steps.env-vars.outputs.EXTRA_TAGS }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Setup env vars
        id: env-vars
        run: |
          branch=$(echo "${{ github.ref }}" | sed -e "s/refs\/heads\///g")
          tag=$(echo "${{ github.event.inputs.tag || '$branch' }}" | sed 's/\//-/g') # replace '/' with '-'
          extra=${{ endsWith(github.ref, '/master') && github.event_name == 'push' && '-t $image_name:master-${GITHUB_SHA:0:7}' || '' }}
          if [[ "$extra" -ne "" ]]; then
            tag="$tag,$extra"
          fi

          echo "BUILD_TIMESTAMP=$(date '+%s')" >> $GITHUB_OUTPUT
          echo "EXTRA_TAGS=$tag" >> $GITHUB_OUTPUT

  publish-docker:
    needs: setup
    uses: NethermindEth/github-workflows/.github/workflows/docker-build-push-dockerhub.yaml@v1.3.4
    with:
      repo_name: nethermindeth
      image_name: ${{ github.event.inputs.image-name || 'nethermind' }}
      push: ${{ github.event_name != 'pull_request' }}
      platforms: "linux/amd64,linux/arm64"
      setup-qemu: true
      dockerfile_path: ${{ github.event.inputs.dockerfile || 'Dockerfile' }}
      docker_build_args: |
        BUILD_TIMESTAMP=${{ needs.setup.outputs.BUILD_TIMESTAMP }}
        BUILD_CONFIG=${{ github.event.inputs.build-config || 'release' }}
        CI=$CI
        COMMIT_HASH=$GITHUB_SHA
      additional_tags: ${{ needs.setup.outputs.EXTRA_TAGS }}
    secrets:
      dockerhub_username: ${{ secrets.DOCKER_USERNAME }}
      dockerhub_password: ${{ secrets.DOCKER_ACCESS_TOKEN }}
