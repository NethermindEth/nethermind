name: '[ALERT] When issue is opened by an external contributor'

on: 
  issues:
    types: opened

jobs:
  alert-team:
    if: github.repository_owner == 'NethermindEth'
    name: Alert team about an issue reported by users
    runs-on: ubuntu-latest
    env: 
      USER: ${{ github.event.issue.user.login }}
      AUTHOR_ASSOCIATION: ${{ github.event.issue.author_association }}
      ISSUE_URL: ${{ github.event.issue.html_url }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
    steps:
    - name: Import Secrets
      uses: hashicorp/vault-action@v2.1.2
      with:
        url: ${{ secrets.VAULT_URL }}
        method: approle
        roleId: ${{ secrets.ROLE_ID }}
        secretId: ${{ secrets.SECRET_ID }}
        namespace: admin/NethermindEth
        secrets: |
            github/nethermind/data/secrets OPSGENIE_API_KEY
    - name: Alert Nethermind Team
      if: ${{ env.AUTHOR_ASSOCIATION == 'NONE' }}
      run: |
        MESSAGE="An issue ${{ env.ISSUE_TITLE }} has been created by a user: ${{ env.USER }}" 
        MESSAGE_FORMATTED=$(echo $MESSAGE | tr -d '"')
        composeMessage() {
        cat <<EOF
        {
          "message": "$MESSAGE_FORMATTED",
          "description":"Github issue URL: ${{ env.ISSUE_URL }}",
          "tags": ["GithubIssues"]
        }
        EOF
        }
        curl -X POST https://api.eu.opsgenie.com/v2/alerts -H "Content-Type: application/json" -H "Authorization: GenieKey ${{ env.OPSGENIE_API_KEY }}" -d "$(composeMessage)"