name: Execute Gas benchmarks

on:
  workflow_dispatch:

env:
  DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: "1"
  TERM: xterm

jobs:
  setup-runner:
    runs-on: ubuntu-latest
    outputs:
      runner-name: ${{ steps.setup-runner.outputs.runner-name }}
      machine-ip: ${{ steps.setup-runner.outputs.machine-ip }}
      run-id: ${{ steps.setup-runner.outputs.run-id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Authenticate App
        id: gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.ADMIN_APP_ID }}
          private-key: ${{ secrets.ADMIN_APP_PRIVATE_KEY }}
          repositories: "nethermind,post-merge-smoke-tests"

      - name: Setup self-hosted runner
        id: setup-runner
        uses: ./.github/actions/setup-runner
        with:
          gh-token: ${{ steps.gh-app.outputs.token }}
          gh-username: ${{ github.actor }}
          runner-name: "gas-benchmark"
          runner-type: g6-standard-2
          timeout: "5"
          setup-wait-time: "60"

  run-on-self-hosted:
    needs: setup-runner
    runs-on: ${{ needs.setup-runner.outputs.runner-name }}
    timeout-minutes: 360

    steps:
      - name: Display runner information
        run: |
          echo "Running on self-hosted runner: ${{ needs.setup-runner.outputs.runner-name }}"
          echo "Machine IP: ${{ needs.setup-runner.outputs.machine-ip }}"
          echo "Workflow Run ID: ${{ needs.setup-runner.outputs.run-id }}"

  cleanup:
    needs: [setup-runner, run-on-self-hosted]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Authenticate App
        id: gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.ADMIN_APP_ID }}
          private-key: ${{ secrets.ADMIN_APP_PRIVATE_KEY }}
          repositories: "nethermind,post-merge-smoke-tests"

      - name: Remove self-hosted runner
        uses: ./.github/actions/remove-runner
        with:
          gh-token: ${{ steps.gh-app.outputs.token }}
          runner-name: ${{ needs.setup-runner.outputs.runner-name }}
          workflow-run-id: ${{ needs.setup-runner.outputs.run-id }}
