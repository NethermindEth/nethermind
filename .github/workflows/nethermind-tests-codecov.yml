name: Nethermind/Ethereum tests with code coverage

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  DOTNET_VERSION: 7

jobs:
  nethermind:
    name: Run ${{ matrix.project }}
    if: github.repository_owner == 'NethermindEth'
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        project:
          - Nethermind.Abi.Test
          - Nethermind.AccountAbstraction.Test
          - Nethermind.Api.Test
          - Nethermind.AuRa.Test
          - Nethermind.Blockchain.Test
          - Nethermind.Cli.Test
          - Nethermind.Clique.Test
          - Nethermind.Config.Test
          - Nethermind.Consensus.Test
          - Nethermind.Core.Test
          - Nethermind.Db.Test
          - Nethermind.Ethash.Test
          - Nethermind.EthStats.Test
          - Nethermind.Evm.Test
          - Nethermind.Facade.Test
          - Nethermind.HealthChecks.Test
          - Nethermind.Hive.Test
          - Nethermind.JsonRpc.Test
          - Nethermind.JsonRpc.TraceStore.Test
          - Nethermind.KeyStore.Test
          - Nethermind.Logging.NLog.Test
          - Nethermind.Merge.AuRa.Test
          - Nethermind.Merge.Plugin.Test
          - Nethermind.Mev.Test
          - Nethermind.Mining.Test
          - Nethermind.Monitoring.Test
          - Nethermind.Network.Test
          - Nethermind.Network.Discovery.Test
          - Nethermind.Network.Dns.Test
          - Nethermind.Network.Enr.Test
          - Nethermind.Overseer.Test
          - Nethermind.Runner.Test
          - Nethermind.Serialization.Ssz.Test
          - Nethermind.Sockets.Test
          - Nethermind.Specs.Test
          - Nethermind.State.Test
          - Nethermind.State.Test.Runner.Test
          - Nethermind.Synchronization.Test
          - Nethermind.Trie.Test
          - Nethermind.TxPool.Test
          - Nethermind.Wallet.Test
    steps:
    - name: Check out repository
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: Install Linux packages
      run: |
        sudo apt-get update
        sudo apt-get install libsnappy-dev -y --no-install-recommends
    - name: ${{ matrix.project }}
      run: dotnet test src/Nethermind/${{ matrix.project }} -c release -p:CollectCoverage=true -p:CoverletOutputFormat=opencover
    - name: Upload test coverage report
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.project }}-coverage
        path: src/Nethermind/${{ matrix.project }}/coverage.opencover.xml
        retention-days: 1

  ethereum:
    name: Run ${{ matrix.project }}
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        project:
          - Ethereum.Abi.Test
          - Ethereum.Basic.Test
          - Ethereum.Blockchain.Block.Test
          - Ethereum.Blockchain.Test
          - Ethereum.Difficulty.Test
          - Ethereum.HexPrefix.Test
          - Ethereum.KeyAddress.Test
          - Ethereum.PoW.Test
          - Ethereum.Rlp.Test
          - Ethereum.Transaction.Test
          - Ethereum.Transition.Test
          - Ethereum.Trie.Test
          - Ethereum.VM.Test
    steps:
    - name: Check out repository
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: Install Linux packages
      run: |
        sudo apt-get update
        sudo apt-get install libsnappy-dev -y --no-install-recommends
    - name: ${{ matrix.project }}
      run: dotnet test src/Nethermind/${{ matrix.project }} -c release -p:CollectCoverage=true -p:CoverletOutputFormat=opencover -p:Exclude="[Nethermind.Core.Test]*%2c[Nethermind.Blockchain.Test]*%2c[Ethereum.Test.Base]*"
    - name: Upload test coverage report
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.project }}-coverage
        path: src/Nethermind/${{ matrix.project }}/coverage.opencover.xml
        retention-days: 1

  codecov-upload:
    name: Upload Codecov reports
    needs: [nethermind, ethereum]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: .coverage
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          name: codecov-nethermind
          directory: .coverage
