name: Nethermind/Ethereum tests

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  push:
    branches: [master]
  workflow_dispatch:

env:
  DOTNET_VERSION: 7

jobs:
  nethermind:
    name: Run ${{ matrix.project }}
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        project:
          - Nethermind.Abi.Test
          - Nethermind.AccountAbstraction.Test
          - Nethermind.Api.Test
          - Nethermind.AuRa.Test
          - Nethermind.Blockchain.Test
          - Nethermind.Cli.Test
          - Nethermind.Clique.Test
          - Nethermind.Config.Test
          - Nethermind.Consensus.Test
          - Nethermind.Core.Test
          - Nethermind.Db.Test
          - Nethermind.Ethash.Test
          - Nethermind.EthStats.Test
          - Nethermind.Evm.Test
          - Nethermind.Facade.Test
          - Nethermind.HealthChecks.Test
          - Nethermind.Hive.Test
          - Nethermind.JsonRpc.Test
          - Nethermind.JsonRpc.TraceStore.Test
          - Nethermind.KeyStore.Test
          - Nethermind.Logging.NLog.Test
          - Nethermind.Merge.AuRa.Test
          - Nethermind.Merge.Plugin.Test
          - Nethermind.Mev.Test
          - Nethermind.Mining.Test
          - Nethermind.Monitoring.Test
          - Nethermind.Network.Discovery.Test
          - Nethermind.Network.Dns.Test
          - Nethermind.Network.Enr.Test
          - Nethermind.Network.Test
          - Nethermind.Overseer.Test
          - Nethermind.Runner.Test
          - Nethermind.Serialization.Ssz.Test
          - Nethermind.Sockets.Test
          - Nethermind.Specs.Test
          - Nethermind.State.Test
          - Nethermind.State.Test.Runner.Test
          - Nethermind.Synchronization.Test
          - Nethermind.Trie.Test
          - Nethermind.TxPool.Test
          - Nethermind.Wallet.Test
    steps:
    - name: Check out repository
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: Install Linux packages
      run: |
        sudo apt-get update
        sudo apt-get install libsnappy-dev -y --no-install-recommends
    - name: ${{ matrix.project }}
      run: dotnet test src/Nethermind/${{ matrix.project }} -c release

  ethereum:
    name: Run ${{ matrix.project }}
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        project:
          - Ethereum.Abi.Test
          - Ethereum.Basic.Test
          - Ethereum.Blockchain.Block.Test
          - Ethereum.Blockchain.Test
          - Ethereum.Difficulty.Test
          - Ethereum.HexPrefix.Test
          - Ethereum.KeyAddress.Test
          - Ethereum.PoW.Test
          - Ethereum.Rlp.Test
          - Ethereum.Transaction.Test
          - Ethereum.Transition.Test
          - Ethereum.Trie.Test
          - Ethereum.VM.Test
    steps:
    - name: Check out repository
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: Install Linux packages
      run: |
        sudo apt-get update
        sudo apt-get install libsnappy-dev -y --no-install-recommends
    - name: ${{ matrix.project }}
      run: dotnet test src/Nethermind/${{ matrix.project }} -c release
