#!/bin/bash
set -e

# GitHub Actions Runner Setup Script
# This script is generated from a Jinja2 template and sets up a self-hosted GitHub Actions runner

# Setup logging
LOG_FILE="${HOME}/runner-setup.log"
exec > >(tee -a "${LOG_FILE}") 2>&1

echo "========================================="
echo "GitHub Actions Runner Setup"
echo "Started at: $(date)"
echo "========================================="

# Display environment for debugging
echo "Environment information:"
echo "  HOME: ${HOME}"
echo "  USER: ${USER}"
echo "  PWD: $(pwd)"
echo "  Hostname: $(hostname)"
echo ""

# Install dependencies
echo "Installing dependencies..."
sudo apt-get update
sudo apt-get install -y curl jq

# Create runner directory
GH_RUNNER_DIR="${HOME}/actions-runner"
echo "Creating runner directory: ${GH_RUNNER_DIR}"
mkdir -p "${GH_RUNNER_DIR}"
cd "${GH_RUNNER_DIR}"

# Download the latest runner package
echo "Downloading GitHub Actions runner..."
RUNNER_VERSION=$(curl -s https://api.github.com/repos/actions/runner/releases/latest | jq -r '.tag_name' | sed 's/v//')
echo "Latest runner version: ${RUNNER_VERSION}"

curl -o actions-runner-linux-x64.tar.gz -L "https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz"

# Verify download
if [ ! -f "actions-runner-linux-x64.tar.gz" ]; then
  echo "Error: Failed to download runner package"
  exit 1
fi

# Extract the installer
echo "Extracting runner package..."
tar xzf ./actions-runner-linux-x64.tar.gz

# Get registration token
echo "Obtaining registration token..."
REGISTRATION_TOKEN=$(curl -s -X POST \
  -H "Authorization: token {{ gh_token }}" \
  -H "Accept: application/vnd.github.v3+json" \
  "https://api.github.com/repos/{{ org_name }}/{{ repo_name }}/actions/runners/registration-token" | jq -r '.token')

if [ -z "$REGISTRATION_TOKEN" ] || [ "$REGISTRATION_TOKEN" = "null" ]; then
  echo "Error: Failed to obtain registration token"
  echo "Response from GitHub API was empty or null"
  exit 1
fi

echo "Registration token obtained successfully"

# Configure the runner
GH_RUNNER_LABEL="{{ runner_label }}"

echo "Configuring runner..."
echo "  Repository: {{ org_name }}/{{ repo_name }}"
echo "  Runner label: ${GH_RUNNER_LABEL}"

./config.sh --url "https://github.com/{{ org_name }}/{{ repo_name }}" \
  --token "$REGISTRATION_TOKEN" \
  --name "${GH_RUNNER_LABEL}" \
  --labels "${GH_RUNNER_LABEL}" \
  --unattended \
  --replace

if [ $? -ne 0 ]; then
  echo "Error: Runner configuration failed"
  exit 1
fi

echo "Runner configured successfully"

# Install and start the runner service
echo "Installing runner service..."
sudo ./svc.sh install

echo "Starting runner service..."
sudo ./svc.sh start

# Verify service is running
sleep 2
SERVICE_STATUS=$(sudo ./svc.sh status || echo "failed")
echo "Service status: ${SERVICE_STATUS}"

echo ""
echo "========================================="
echo "GitHub Actions Runner Setup Complete"
echo "Completed at: $(date)"
echo "========================================="
echo ""
echo "Runner Information:"
echo "  Label: ${GH_RUNNER_LABEL}"
echo "  Directory: ${GH_RUNNER_DIR}"
echo "  Log file: ${LOG_FILE}"
echo ""
