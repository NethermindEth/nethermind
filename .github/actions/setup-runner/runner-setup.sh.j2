#!/bin/bash
set -e

# GitHub Actions Runner Setup Script
# This script is generated from a Jinja2 template and sets up a self-hosted GitHub Actions runner

echo "========================================="
echo "GitHub Actions Runner Setup"
echo "Started at: $(date)"
echo "========================================="

# Display environment for debugging
echo "Environment information:"
echo "  HOME: ${HOME}"
echo "  USER: ${USER}"
echo "  PWD: $(pwd)"
echo "  Hostname: $(hostname)"
echo ""

# Check if running as root
if [ "$(id -u)" -ne 0 ]; then
  echo "Error: This script must be run as root"
  exit 1
fi

# Install dependencies
echo "Installing dependencies..."

# Preparing Git-LFS
curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash

apt-get update
apt-get install -y curl jq git-lfs

# Create runner user if it doesn't exist
echo "Creating dedicated runner user..."
if ! id "runner" &>/dev/null; then
  useradd -m -s /bin/bash runner
  echo "Created user 'runner'"
else
  echo "User 'runner' already exists"
fi

# Create runner directory
GH_RUNNER_DIR="/home/runner/actions-runner"
echo "Creating runner directory: ${GH_RUNNER_DIR}"
mkdir -p "${GH_RUNNER_DIR}"
cd "${GH_RUNNER_DIR}"

# Download the latest runner package
echo "Downloading GitHub Actions runner..."
RUNNER_VERSION=$(curl -s https://api.github.com/repos/actions/runner/releases/latest | jq -r '.tag_name' | sed 's/v//')
echo "Latest runner version: ${RUNNER_VERSION}"

curl -o actions-runner-linux-x64.tar.gz -L "https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz"

# Verify download
if [ ! -f "actions-runner-linux-x64.tar.gz" ]; then
  echo "Error: Failed to download runner package"
  exit 1
fi

# Extract the installer
echo "Extracting runner package..."
tar xzf ./actions-runner-linux-x64.tar.gz

# Set ownership to runner user
echo "Setting ownership to runner user..."
chown -R runner:runner "${GH_RUNNER_DIR}"

# Get registration token
echo "Obtaining registration token..."
REGISTRATION_TOKEN=$(curl -s -X POST \
  -H "Authorization: token {{ gh_token }}" \
  -H "Accept: application/vnd.github.v3+json" \
  "https://api.github.com/repos/{{ org_name }}/{{ repo_name }}/actions/runners/registration-token" | jq -r '.token')

if [ -z "$REGISTRATION_TOKEN" ] || [ "$REGISTRATION_TOKEN" = "null" ]; then
  echo "Error: Failed to obtain registration token"
  echo "Response from GitHub API was empty or null"
  exit 1
fi

echo "Registration token obtained successfully"

# Configure the runner (as runner user)
GH_RUNNER_LABEL="{{ runner_label }}"

echo "Configuring runner..."
echo "  Repository: {{ org_name }}/{{ repo_name }}"
echo "  Runner label: ${GH_RUNNER_LABEL}"

su - runner -c "cd ${GH_RUNNER_DIR} && ./config.sh --url 'https://github.com/{{ org_name }}/{{ repo_name }}' \
  --token '${REGISTRATION_TOKEN}' \
  --name '${GH_RUNNER_LABEL}' \
  --labels '${GH_RUNNER_LABEL}' \
  --unattended \
  --replace"

if [ $? -ne 0 ]; then
  echo "Error: Runner configuration failed"
  exit 1
fi

echo "Runner configured successfully"

# Install and start the runner service (as root)
echo "Installing runner service..."
cd "${GH_RUNNER_DIR}"
./svc.sh install runner

echo "Starting runner service..."
./svc.sh start

# Verify service is running
sleep 2
SERVICE_STATUS=$(./svc.sh status || echo "failed")
echo "Service status: ${SERVICE_STATUS}"

echo ""
echo "========================================="
echo "GitHub Actions Runner Setup Complete"
echo "Completed at: $(date)"
echo "========================================="
echo ""
echo "Runner Information:"
echo "  Label: ${GH_RUNNER_LABEL}"
echo "  Directory: ${GH_RUNNER_DIR}"
echo "  Log file: ${LOG_FILE}"
echo ""
