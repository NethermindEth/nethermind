"use strict";function _classCallCheck(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(r,t){for(var n=0;n<t.length;n++){var e=t[n];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(r,e.key,e)}}function _createClass(r,t,n){return t&&_defineProperties(r.prototype,t),n&&_defineProperties(r,n),r}function _createForOfIteratorHelper(r,t){var n,e="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(!e){if(Array.isArray(r)||(e=_unsupportedIterableToArray(r))||t&&r&&"number"==typeof r.length)return e&&(r=e),n=0,{s:t=function(){},n:function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},e:function(r){throw r},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,u=!0,a=!1;return{s:function(){e=e.call(r)},n:function(){var r=e.next();return u=r.done,r},e:function(r){a=!0,o=r},f:function(){try{u||null==e.return||e.return()}finally{if(a)throw o}}}}function _unsupportedIterableToArray(r,t){if(r){if("string"==typeof r)return _arrayLikeToArray(r,t);var n=Object.prototype.toString.call(r).slice(8,-1);return"Map"===(n="Object"===n&&r.constructor?r.constructor.name:n)||"Set"===n?Array.from(r):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(r,t):void 0}}function _arrayLikeToArray(r,t){(null==t||t>r.length)&&(t=r.length);for(var n=0,e=new Array(t);n<t;n++)e[n]=r[n];return e}var entities=require("entities"),defaults={fg:"#FFF",bg:"#000",newline:!1,escapeXML:!1,stream:!1,colors:getDefaultColors()};function getDefaultColors(){var e={0:"#000",1:"#A00",2:"#0A0",3:"#A50",4:"#00A",5:"#A0A",6:"#0AA",7:"#AAA",8:"#555",9:"#F55",10:"#5F5",11:"#FF5",12:"#55F",13:"#F5F",14:"#5FF",15:"#FFF"};return range(0,5).forEach(function(n){range(0,5).forEach(function(t){range(0,5).forEach(function(r){return setStyleColor(n,t,r,e)})})}),range(0,23).forEach(function(r){var t=r+232,r=toHexString(10*r+8);e[t]="#"+r+r+r}),e}function setStyleColor(r,t,n,e){e[16+36*r+6*t+n]=toColorHexString([0<r?40*r+55:0,0<t?40*t+55:0,0<n?40*n+55:0])}function toHexString(r){for(var t=r.toString(16);t.length<2;)t="0"+t;return t}function toColorHexString(r){var t,n=[],e=_createForOfIteratorHelper(r);try{for(e.s();!(t=e.n()).done;){var o=t.value;n.push(toHexString(o))}}catch(r){e.e(r)}finally{e.f()}return"#"+n.join("")}function generateOutput(r,t,n,e){var o;return"text"===t?o=pushText(n,e):"display"===t?o=handleDisplay(r,n,e):"xterm256Foreground"===t?o=pushForegroundColor(r,e.colors[n]):"xterm256Background"===t?o=pushBackgroundColor(r,e.colors[n]):"rgb"===t&&(o=handleRgb(r,n)),o}function handleRgb(r,t){return pushStyle(r,(38==+(t=t.substring(2).slice(0,-1)).substr(0,2)?"color:#":"background-color:#")+t.substring(5).split(";").map(function(r){return("0"+Number(r).toString(16)).substr(-2)}).join(""))}function handleDisplay(r,t,n){var e,o={"-1":function(){return"<br/>"},0:function(){return r.length&&resetStyles(r)},1:function(){return pushTag(r,"b")},3:function(){return pushTag(r,"i")},4:function(){return pushTag(r,"u")},8:function(){return pushStyle(r,"display:none")},9:function(){return pushTag(r,"strike")},22:function(){return pushStyle(r,"font-weight:normal;text-decoration:none;font-style:normal")},23:function(){return closeTag(r,"i")},24:function(){return closeTag(r,"u")},39:function(){return pushForegroundColor(r,n.fg)},49:function(){return pushBackgroundColor(r,n.bg)},53:function(){return pushStyle(r,"text-decoration:overline")}};return o[t=parseInt(t,10)]?e=o[t]():4<t&&t<7?e=pushTag(r,"blink"):29<t&&t<38?e=pushForegroundColor(r,n.colors[t-30]):39<t&&t<48?e=pushBackgroundColor(r,n.colors[t-40]):89<t&&t<98?e=pushForegroundColor(r,n.colors[t-90+8]):99<t&&t<108&&(e=pushBackgroundColor(r,n.colors[t-100+8])),e}function resetStyles(r){var t=r.slice(0);return r.length=0,t.reverse().map(function(r){return"</"+r+">"}).join("")}function range(r,t){for(var n=[],e=r;e<=t;e++)n.push(e);return n}function notCategory(t){return function(r){return(null===t||r.category!==t)&&"all"!==t}}function categoryForCode(r){var t=null;return 0===(r=parseInt(r,10))?t="all":1===r?t="bold":2<r&&r<5?t="underline":4<r&&r<7?t="blink":8===r?t="hide":9===r?t="strike":29<r&&r<38||39===r||89<r&&r<98?t="foreground-color":(39<r&&r<48||49===r||99<r&&r<108)&&(t="background-color"),t}function pushText(r,t){return t.escapeXML?entities.encodeXML(r):r}function pushTag(r,t,n){return n=n||"",r.push(t),"<".concat(t).concat(n?' style="'.concat(n,'"'):"",">")}function pushStyle(r,t){return pushTag(r,"span",t)}function pushForegroundColor(r,t){return pushTag(r,"span","color:"+t)}function pushBackgroundColor(r,t){return pushTag(r,"span","background-color:"+t)}function closeTag(r,t){var n;if(n=r.slice(-1)[0]===t?r.pop():n)return"</"+t+">"}function tokenize(r,t,u){var a=!1;function n(){return""}function e(r){return t.newline?u("display",-1):u("text",r),""}var o=[{pattern:/^\x08+/,sub:n},{pattern:/^\x1b\[[012]?K/,sub:n},{pattern:/^\x1b\[\(B/,sub:n},{pattern:/^\x1b\[[34]8;2;\d+;\d+;\d+m/,sub:function(r){return u("rgb",r),""}},{pattern:/^\x1b\[38;5;(\d+)m/,sub:function(r,t){return u("xterm256Foreground",t),""}},{pattern:/^\x1b\[48;5;(\d+)m/,sub:function(r,t){return u("xterm256Background",t),""}},{pattern:/^\n/,sub:e},{pattern:/^\r+\n/,sub:e},{pattern:/^\r/,sub:e},{pattern:/^\x1b\[((?:\d{1,3};?)+|)m/,sub:function(r,t){a=!0;var n,e=_createForOfIteratorHelper(t=(t=0===t.trim().length?"0":t).trimRight(";").split(";"));try{for(e.s();!(n=e.n()).done;){var o=n.value;u("display",o)}}catch(r){e.e(r)}finally{e.f()}return""}},{pattern:/^\x1b\[\d?J/,sub:n},{pattern:/^\x1b\[\d{0,3};\d{0,3}f/,sub:n},{pattern:/^\x1b\[?[\d;]{0,3}/,sub:n},{pattern:/^(([^\x1b\x08\r\n])+)/,sub:function(r){return u("text",r),""}}];var i,c=[],s=r.length;r:for(;0<s;){for(var l=0,f=0,p=o.length;f<p;l=++f)if(i=o[l],3<l&&a||(a=!1,r=r.replace(i.pattern,i.sub)),r.length!==s){s=r.length;continue r}if(r.length===s)break;c.push(0),s=r.length}return c}function updateStickyStack(r,t,n){return"text"!==t&&(r=r.filter(notCategory(categoryForCode(n)))).push({token:t,data:n,category:categoryForCode(n)}),r}var Filter=function(){function t(r){_classCallCheck(this,t),(r=r||{}).colors&&(r.colors=Object.assign({},defaults.colors,r.colors)),this.options=Object.assign({},defaults,r),this.stack=[],this.stickyStack=[]}return _createClass(t,[{key:"toHtml",value:function(r){var e=this,o=(r="string"==typeof r?[r]:r,this.stack),u=this.options,a=[];return this.stickyStack.forEach(function(r){r=generateOutput(o,r.token,r.data,u);r&&a.push(r)}),tokenize(r.join(""),u,function(r,t){var n=generateOutput(o,r,t,u);n&&a.push(n),u.stream&&(e.stickyStack=updateStickyStack(e.stickyStack,r,t))}),o.length&&a.push(resetStyles(o)),a.join("")}}]),t}();module.exports=Filter;