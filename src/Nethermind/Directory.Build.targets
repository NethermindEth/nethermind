<Project>
  <PropertyGroup>
    <Product>Nethermind</Product>
    <Copyright>Demerzel Solutions Limited</Copyright>
  </PropertyGroup>
  
  <Target Name="ProductInfo" BeforeTargets="BeforeBuild">
    <Message Text="Building version from Git log" />
    <Exec Command="git describe --tag --always" ConsoleToMSBuild="True" IgnoreExitCode="False" StandardOutputImportance="low">
      <Output PropertyName="GitTag" TaskParameter="ConsoleOutput" />
    </Exec>
    <Exec Command="git describe --long --always --exclude=* --abbrev=40" ConsoleToMSBuild="True" IgnoreExitCode="False" StandardOutputImportance="low">
      <Output PropertyName="GitCommitHash" TaskParameter="ConsoleOutput" />
    </Exec>
    <Exec Command="git show -s --format=%25%25ct $(GitCommitHash)" ConsoleToMSBuild="True" IgnoreExitCode="False" StandardOutputImportance="low">
      <Output PropertyName="GitCommitTimestamp" TaskParameter="ConsoleOutput" />
    </Exec>
    <PropertyGroup>
      <!-- Use DateTimeOffset for MSBuild v17.3 -->
      <GitCommitTimestamp Condition="'$(Configuration)' == 'Debug'">$([System.Convert]::ToInt64($([System.DateTime]::UtcNow.Subtract($([System.DateTime]::new(1970, 1, 1))).TotalSeconds)))</GitCommitTimestamp>
      <SourceRevisionId>$(GitCommitHash.Substring(0, 8))</SourceRevisionId>
      <Version>$(GitTag)</Version>
      <Version Condition="'$(Configuration)' == 'Debug'">$(GitTag)-debug</Version>
    </PropertyGroup>
    <ItemGroup>
      <AssemblyAttribute Include="Nethermind.Core.GitCommitAttribute">
        <_Parameter1>$(GitCommitHash)</_Parameter1>
        <_Parameter2>$(GitCommitTimestamp)</_Parameter2>
      </AssemblyAttribute>
    </ItemGroup>
  </Target>
</Project>
