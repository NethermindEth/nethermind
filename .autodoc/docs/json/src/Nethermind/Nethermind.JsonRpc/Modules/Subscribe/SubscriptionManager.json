{
  "fileName": "SubscriptionManager.cs",
  "filePath": "src/Nethermind/Nethermind.JsonRpc/Modules/Subscribe/SubscriptionManager.cs",
  "url": "https://github.com/NethermindEth/nethermind/src/Nethermind/Nethermind.JsonRpc/Modules/Subscribe/SubscriptionManager.cs",
  "summary": "The `SubscriptionManager` class is responsible for managing subscriptions to JSON-RPC notifications. It provides methods for adding and removing subscriptions, as well as for removing all subscriptions associated with a particular JSON-RPC client. \n\nWhen a new subscription is added, the `AddSubscription` method creates a new `Subscription` object using the provided `ISubscriptionFactory` and adds it to two dictionaries: `_subscriptions` and `_subscriptionsByJsonRpcClient`. The former is a dictionary of all subscriptions, keyed by their unique ID, while the latter is a dictionary of subscriptions grouped by the JSON-RPC client that created them. \n\nWhen a subscription is removed, the `RemoveSubscription` method first checks that the subscription exists and was created by the specified JSON-RPC client. If so, it disposes of the subscription and removes it from both dictionaries. \n\nThe `RemoveClientSubscriptions` method removes all subscriptions associated with a particular JSON-RPC client. It first looks up the client's subscriptions in the `_subscriptionsByJsonRpcClient` dictionary, disposes of each subscription, and removes it from the `_subscriptions` dictionary. \n\nThe `SubscriptionManager` class is used by other modules in the Nethermind project that require subscription management, such as the `EthModule`. For example, the `EthModule` uses the `SubscriptionManager` to manage subscriptions to new block headers, which are sent as JSON-RPC notifications. \n\n```csharp\npublic class EthModule : ModuleBase\n{\n    private readonly IBlockTree _blockTree;\n    private readonly IBlockTree _canonicalBlockTree;\n    private readonly IStateReader _stateReader;\n    private readonly IStateProvider _stateProvider;\n    private readonly ITransactionPool _transactionPool;\n    private readonly IJsonSerializer _jsonSerializer;\n    private readonly ISubscriptionManager _subscriptionManager;\n    private readonly IBlockValidator _blockValidator;\n    private readonly ILogManager _logManager;\n    private readonly IBlockPreprocessor _blockPreprocessor;\n    private readonly IBlockProcessor _blockProcessor;\n    private readonly IBlockTreeSynchronizer _blockTreeSynchronizer;\n    private readonly IBlockTreeSyncStats _blockTreeSyncStats;\n    private readonly IBlockTreeSyncState _blockTreeSyncState;\n    private readonly IBlockTreeSyncQueue _blockTreeSyncQueue;\n    private readonly IBlockTreeSync _blockTreeSync;\n    private readonly IBlockTreeSyncServer _blockTreeSyncServer;\n    private readonly IBlockTreeSyncClient _blockTreeSyncClient;\n    private readonly IBlockTreeSyncPeerPool _blockTreeSyncPeerPool;\n    private readonly IBlockTreeSyncPeerPoolManager _blockTreeSyncPeerPoolManager;\n    private readonly IBlockTreeSyncPeerPoolConfig _blockTreeSyncPeerPoolConfig;\n    private readonly IBlockTreeSyncPeerPoolStats _blockTreeSyncPeerPoolStats;\n    private readonly IBlockTreeSyncPeerPoolStatsProvider _blockTreeSyncPeerPoolStatsProvider;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderConfig _blockTreeSyncPeerPoolStatsProviderConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderFactory _blockTreeSyncPeerPoolStatsProviderFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManager _blockTreeSyncPeerPoolStatsProviderManager;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerConfig _blockTreeSyncPeerPoolStatsProviderManagerConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerFactory _blockTreeSyncPeerPoolStatsProviderManagerFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStats _blockTreeSyncPeerPoolStatsProviderManagerStats;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProvider _blockTreeSyncPeerPoolStatsProviderManagerStatsProvider;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManager _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManager;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStats _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStats;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProvider _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProvider;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManager _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManager;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStats _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStats;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProvider _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProvider;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManager _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManager;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStats _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStats;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProvider _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProvider;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManager _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManager;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStats _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStats;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProvider _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProvider;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManager _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManager;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStats _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStats;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerFactory;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProvider _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProvider;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderConfig _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderConfig;\n    private readonly IBlockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderFactory _blockTreeSyncPeerPoolStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProviderManagerStatsProvider",
  "questions": "1. What is the purpose of the `SubscriptionManager` class?\n- The `SubscriptionManager` class is responsible for managing subscriptions to JSON-RPC notifications and returning subscription IDs.\n\n2. What is the purpose of the `_subscriptions` and `_subscriptionsByJsonRpcClient` dictionaries?\n- The `_subscriptions` dictionary stores all active subscriptions, while the `_subscriptionsByJsonRpcClient` dictionary stores all subscriptions for a given JSON-RPC client.\n\n3. What happens when a JSON-RPC client is closed?\n- When a JSON-RPC client is closed, all of its subscriptions are removed from the `_subscriptions` dictionary and the `_subscriptionsByJsonRpcClient` dictionary, and the corresponding `Subscription` objects are disposed."
}