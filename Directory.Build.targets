<Project>

  <!-- Skip copying dependencies and native runtimes for library projects. -->
  <PropertyGroup Condition="'$(OutputType)' != 'Exe' and '$(OutputType)' != 'WinExe'">
    <CopyLocalLockFileAssemblies>false</CopyLocalLockFileAssemblies>
    <CopyLocalRuntimeTargetAssets>false</CopyLocalRuntimeTargetAssets>
  </PropertyGroup>

  <!-- Filter native runtimes to current OS only during local builds. -->
  <PropertyGroup Condition="'$(CI)' != 'true'">
    <_NethermindRuntimePrefix Condition="$([MSBuild]::IsOSPlatform('Windows'))">win-</_NethermindRuntimePrefix>
    <_NethermindRuntimePrefix Condition="$([MSBuild]::IsOSPlatform('Linux'))">linux-</_NethermindRuntimePrefix>
    <_NethermindRuntimePrefix Condition="$([MSBuild]::IsOSPlatform('OSX'))">osx-</_NethermindRuntimePrefix>
  </PropertyGroup>

  <Target Name="_FilterRuntimeAssetsToCurrentOS"
          AfterTargets="ResolvePackageAssets"
          Condition="'$(NethermindCopyAllRuntimes)' != 'true' and '$(_NethermindRuntimePrefix)' != ''">
    <ItemGroup>
      <RuntimeTargetsCopyLocalItems Remove="@(RuntimeTargetsCopyLocalItems)"
          Condition="($([System.String]::Copy('%(Identity)').Contains('\runtimes\')) or $([System.String]::Copy('%(Identity)').Contains('/runtimes/'))) and
                     !$([System.String]::Copy('%(Identity)').Contains('\runtimes\$(_NethermindRuntimePrefix)')) and
                     !$([System.String]::Copy('%(Identity)').Contains('/runtimes/$(_NethermindRuntimePrefix)'))" />
      <NativeCopyLocalItems Remove="@(NativeCopyLocalItems)"
          Condition="($([System.String]::Copy('%(Identity)').Contains('\runtimes\')) or $([System.String]::Copy('%(Identity)').Contains('/runtimes/'))) and
                     !$([System.String]::Copy('%(Identity)').Contains('\runtimes\$(_NethermindRuntimePrefix)')) and
                     !$([System.String]::Copy('%(Identity)').Contains('/runtimes/$(_NethermindRuntimePrefix)'))" />
    </ItemGroup>
  </Target>

  <!-- Share native runtimes across projects during local builds with a shared location and junctions/symlinks. -->
  <PropertyGroup Condition="'$(CI)' != 'true'">
    <_SharedRuntimesDir>$(ArtifactsPath)\shared-runtimes\$(Configuration)\</_SharedRuntimesDir>
  </PropertyGroup>

  <Target Name="_UseSharedNativeRuntimes"
          AfterTargets="Build"
          Condition="'$(CI)' != 'true' and '$(_SharedRuntimesDir)' != '' and Exists('$(OutputPath)runtimes')">
    <ItemGroup>
      <_RuntimeFilesToShare Include="$(OutputPath)runtimes\**\*" />
    </ItemGroup>

    <!-- Copy to shared location (skips unchanged files) -->
    <Copy SourceFiles="@(_RuntimeFilesToShare)"
          DestinationFiles="@(_RuntimeFilesToShare->'$(_SharedRuntimesDir)%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />

    <!-- Replace with junction (Windows) or symlink (Linux/macOS) -->
    <RemoveDir Directories="$(OutputPath)runtimes" />
    <Exec Command="mklink /J &quot;$(OutputPath)runtimes&quot; &quot;$(_SharedRuntimesDir.TrimEnd('\'))&quot;"
          Condition="$([MSBuild]::IsOSPlatform('Windows'))" />
    <Exec Command="ln -sfn &quot;$(_SharedRuntimesDir.TrimEnd('/'))&quot; &quot;$(OutputPath)runtimes&quot;"
          Condition="!$([MSBuild]::IsOSPlatform('Windows'))" />
  </Target>

  <!-- Share dependency DLLs across projects during local builds using hard links. -->
  <PropertyGroup Condition="'$(CI)' != 'true'">
    <_SharedDepsDir>$(ArtifactsPath)\shared-deps\$(Configuration)\</_SharedDepsDir>
  </PropertyGroup>

  <Target Name="_UseSharedDependencyDlls"
          AfterTargets="Build"
          Condition="'$(CI)' != 'true' and '$(_SharedDepsDir)' != ''">
    <!-- Get dependency DLLs and PDBs, excluding project's own output and runtime-specific files -->
    <ItemGroup>
      <_DepsToShare Include="$(OutputPath)*.dll;$(OutputPath)*.pdb"
                    Exclude="$(OutputPath)$(AssemblyName).dll;$(OutputPath)$(AssemblyName).pdb;$(OutputPath)testhost.*;$(OutputPath)Microsoft.TestPlatform.*" />
    </ItemGroup>

    <!-- Skip if no dependencies to share -->
    <PropertyGroup>
      <_HasDepsToShare>@(_DepsToShare->Count())</_HasDepsToShare>
    </PropertyGroup>

    <!-- Copy to shared location (first project to build populates it) -->
    <MakeDir Directories="$(_SharedDepsDir)" Condition="'$(_HasDepsToShare)' != '0'" />
    <Copy SourceFiles="@(_DepsToShare)"
          DestinationFolder="$(_SharedDepsDir)"
          SkipUnchangedFiles="true"
          Condition="'$(_HasDepsToShare)' != '0'" />

    <!-- Replace with hard links using single batch command (much faster than per-file mklink) -->
    <Delete Files="@(_DepsToShare)" Condition="'$(_HasDepsToShare)' != '0'" />
    <Exec Command="for %%f in (&quot;$(_SharedDepsDir)*.dll&quot; &quot;$(_SharedDepsDir)*.pdb&quot;) do @(if not exist &quot;%%~nxf&quot; mklink /H &quot;%%~nxf&quot; &quot;%%f&quot; >nul)"
          Condition="$([MSBuild]::IsOSPlatform('Windows')) and '$(_HasDepsToShare)' != '0'"
          WorkingDirectory="$(OutputPath)" />
    <Exec Command="for f in &quot;$(_SharedDepsDir)&quot;*.dll &quot;$(_SharedDepsDir)&quot;*.pdb; do fn=$(basename &quot;$f&quot;); [ ! -e &quot;$fn&quot; ] &amp;&amp; ln &quot;$f&quot; &quot;$fn&quot; 2>/dev/null; done; true"
          Condition="!$([MSBuild]::IsOSPlatform('Windows')) and '$(_HasDepsToShare)' != '0'"
          WorkingDirectory="$(OutputPath)" />
  </Target>

</Project>
